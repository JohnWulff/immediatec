# @(#)$Id: Makefile.in,v 1.46 2006/04/17 20:34:53 jw Exp $

############################################################
#
#	Copyright (C) 1985-2005  John E. Wulff
#
#   You may distribute under the terms of either the GNU General Public
#   License or the Artistic License, as specified in the README file.
#
#   For more information about this program, or for information on how
#   to contact the author, see the README file or <john@je-wulff.de>
#
#	Makefile for immediate C compilers and runtime library
#	J.E. Wulff	14-Mar-87
#
#	use GNU make	28-Jul-96
#	use GNU autoconf and configure	6.Mar.2001
#	use GNU make pattern rules instead of suffix rules 3.Jan.2005
#
#	to make immcc, make with OPT=''
#	to make icr, make with OPT='-DRUN -DYYDEBUG'
#	to make ict, remove all objects and make with OPT='-DTCP'
#	to make libict.a, remove all objects and make with OPT='-DLOAD -DTCP'
#	to make lmain, remove all objects and make with OPT='-DLMAIN -DYYDEBUG'
#
#	auxiliary script makeAll -rm called for all: does this automatically
#
############################################################

#### Start of system configuration section. ####

srcdir = @srcdir@
VPATH = @srcdir@

CC = @CC@
ifeq ($(CC),gcc)
O0 = -O0
else
O0 =
endif

LEX = @LEX@
LEXLIB = @LEXLIB@
YACC = @YACC@
ifeq ($(YACC),yacc)
Y = -DYACC
else
Y =
endif
INSTALL = @INSTALL@ -D -p
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_DATA = @INSTALL_DATA@

CFLAGS = @CFLAGS@
CFLAGS_COMPILE_ONLY = -c $(OPT) $(Y) -DCC=$(CC)
LDFLAGS = @LDFLAGS@
YFLAGS = -d -v
O=o

ifeq ($(findstring EFENCE,$(OPT)),EFENCE)
EL = -lefence
else
EL =
endif

LIBS = @LIBS@

prefix = @prefix@
exec_prefix = @exec_prefix@

# Where the installed binary goes.
bindir = @bindir@
binprefix =

mandir = @mandir@
manext = 1
manprefix =

PSED = perl -e 'while (<>) { if ( s /^.*icc.v,v (\d+\.\d+).*$$/icc.v $$1/ ) { print; last; } }'
PREV = perl -e 'while (<>) { if ( s /^.*icc.v,v (\d+\.\d+).*$$/$$1/ ) { print; last; } }'
PMOD = perl -e 'while (<>) { if ( m /^\/tmp\/[a-z_A-Z]\w*\.o(\(\.data\+0x[a-f\d]+\))*:/ ) { s //\/tmp\/x.o:/; } print; }'
PADD = perl -e 'while (<>) { if ( m /^[a-z_A-Z]/ ) { s /^/'icc_$$rev'\//; print; } }'

#### End of system configuration section. ####

SHELL = /bin/sh

# This rule allows us to supply the necessary -D options
# in addition to whatever the user asks for.
%.$(O):	$(srcdir)/%.c
	$(CC) -I. $(CFLAGS_COMPILE_ONLY) $(CPPFLAGS) $(CFLAGS) $<

###########################################################

COBJ =	comp.$(O) genr.$(O) init.$(O) symb.$(O) outp.$(O) gram.$(O) lexc.$(O)
POBJ =	link.$(O) rsff.$(O) scan.$(O)

#### Standalone versions ###################################
#### make icr and lmain with YYDEBUG, since they need it for normal operation

all:
	@$(srcdir)/makeAll -rm -o$(O)

quiet:
	@$(srcdir)/makeAll -qrm -o$(O)

immcc:	$(srcdir)/Makefile icc.$(O) misc.$(O) scid.$(O) $(COBJ) pplstfix
	$(CC) $(LDFLAGS) -o immcc icc.$(O) misc.$(O) scid.$(O) $(COBJ) $(EL)

icr:	$(srcdir)/Makefile icc.$(O) misc.$(O) scid.$(O) icr.$(O) cexe.$(O) $(COBJ) $(POBJ) pplstfix
	$(CC) $(LDFLAGS) -o icr icc.$(O) misc.$(O) scid.$(O) icr.$(O) cexe.$(O) $(COBJ) $(POBJ) $(EL)

ict:	$(srcdir)/Makefile icc.$(O) misc.$(O) scid.$(O) ict.$(O) cexe.$(O) tcpc.$(O) $(COBJ) $(POBJ) pplstfix
	$(CC) $(LDFLAGS) -o ict icc.$(O) misc.$(O) scid.$(O) ict.$(O) cexe.$(O) tcpc.$(O) $(COBJ) $(POBJ) $(EL)

#### Run-time library ######################################

libict.a:	$(srcdir)/Makefile load.$(O) misc.$(O) scid.$(O) ict.$(O) tcpc.$(O) $(POBJ)
	ar -rvs libict.a load.$(O) misc.$(O) scid.$(O) ict.$(O) tcpc.$(O) $(POBJ)

#### C-parser test #########################################

lmain:	$(srcdir)/Makefile lmain.$(O) misc.$(O) gram.$(O) lexc.$(O) symb.$(O)
	$(CC) $(LDFLAGS) -o lmain lmain.$(O) misc.$(O) gram.$(O) lexc.$(O) symb.$(O) $(EL)

#### Compile objects #######################################

pplstfix:
	@$(SHELL) -ec 'if [ ! -x pplstfix -a ! -L pplstfix -a -x $(srcdir)/pplstfix ]; then rm -f pplstfix; echo "ln -s $(srcdir)/pplstfix ."; ln -s $(srcdir)/pplstfix .; fi'

%.c:	%.l
    ifneq ($(LEX),)
	rm -f $@
	$(LEX) -t $< | perl $(srcdir)/gram.pl > $@
	chmod -w $@
    else
	@echo "System has no lex or flex - install one of them"
	@echo "Otherwise do not modify $< - use $@ in distribution"
	test -f $@ && touch $@
    endif

%.c:	%.y
    ifneq ($(YACC),)
	$(SHELL) -ec 'if [ -f $(*)_tab.h ]; then mv -f $(*)_tab.h y.tab.t; fi'
	rm -f y.tab.c $@
	$(YACC) $(YFLAGS) $<
	perl $*.pl y.tab.c > $@
	perl $*.pl y.tab.h > $(*)_tab.h
	$(SHELL) -ec 'if cmp -s $(*)_tab.h y.tab.t; then mv y.tab.t $(*)_tab.h; fi'
	rm -f y.tab.t y.tab.h y.tab.c
	chmod -w $(*)_tab.h $@
	mv y.output $*.output
    else
	@echo "System has no yacc, bison or byacc - install one of them"
	@echo "Otherwise do not modify $< - use $@ and $(*)_tab.h in distribution"
	test -f $@ && touch $@
    endif

%.1.gz:	%
####	@echo "$(srcdir)/pod2man -n $* -c 'iC Project Documentation' -r \"`$(PSED) $(srcdir)/scid.c`\" $< > $*.1"
	@$(srcdir)/pod2man -n $* -c 'iC Project Documentation' -r "`$(PSED) $(srcdir)/scid.c`" $< > $*.1
	@gzip -f $*.1

$(srcdir)/scid.c:	$(srcdir)/icc.v $(srcdir)/Makefile.in $(srcdir)/pawk.pl $(srcdir)/comp.pl $(srcdir)/gram.pl $(srcdir)/pplstfix $(srcdir)/../README
	rm -f $(srcdir)/scid.c; ident $(srcdir)/icc.v $(srcdir)/Makefile.in $(srcdir)/comp.pl $(srcdir)/gram.pl $(srcdir)/pplstfix | perl $(srcdir)/pawk.pl > $(srcdir)/scid.c; chmod -w $(srcdir)/scid.c

$(srcdir)/../README:	$(srcdir)/icc.v $(srcdir)/README.tpl
	ident $(srcdir)/icc.v | $(srcdir)/README.tpl > $(srcdir)/../README;

$(srcdir)/comp.c:	$(srcdir)/comp.y $(srcdir)/comp.pl

$(srcdir)/gram.c:	$(srcdir)/gram.y $(srcdir)/gram.pl

$(srcdir)/lexc.c:	$(srcdir)/lexc.l $(srcdir)/gram.pl

$(srcdir)/cexe.c:	$(srcdir)/cexe.h
	rm -f /tmp/cexe.c
	$(SHELL) -ec 'test -f $(srcdir)/cexe.c && mv $(srcdir)/cexe.c /tmp; ./immcc -c -d20000 < /dev/null; if cmp -s cexe.c /tmp/cexe.c; then mv /tmp/cexe.c .; fi'
	$(SHELL) -ec 'if [ "$(srcdir)" != '.' ]; then mv cexe.c $(srcdir)/cexe.c; fi'
	rm -f /tmp/cexe.c

$(srcdir)/immcc.1.gz:	$(srcdir)/icc.c $(srcdir)/scid.c
####	@echo "$(srcdir)/pod2man -n immcc -c 'iC Project Documentation' -r \"`$(PSED) $(srcdir)/scid.c`\" $< > $(srcdir)/immcc.1"
	@$(srcdir)/pod2man -n immcc -c 'iC Project Documentation' -r "`$(PSED) $(srcdir)/scid.c`" $< > $(srcdir)/immcc.1
	@gzip -f $(srcdir)/immcc.1

$(srcdir)/iCbox.1.gz:	$(srcdir)/iCbox $(srcdir)/scid.c

$(srcdir)/iClift.1.gz:	$(srcdir)/iClift $(srcdir)/scid.c

$(srcdir)/iClive.1.gz:	$(srcdir)/iClive $(srcdir)/scid.c

$(srcdir)/iCman.1.gz:	$(srcdir)/iCman $(srcdir)/scid.c

$(srcdir)/iCserver.1.gz:	$(srcdir)/iCserver $(srcdir)/scid.c

$(srcdir)/iCmake.1.gz:	$(srcdir)/iCmake $(srcdir)/scid.c

$(srcdir)/makeAll.1.gz:	$(srcdir)/makeAll $(srcdir)/scid.c

test:
	@echo "compile and generate all executables from iC files in ${srcdir}/Test0 ..."
	@-${srcdir}/iCmake -Aiw. ${srcdir}/Test0/*.ic 2>&1 | $(PMOD) > ${srcdir}/Test0/Init.out
	@echo "diffing generated files in ${srcdir}/Test0 with originals in ${srcdir}/Test0/ORG ..."
	@if ${srcdir}/Mdiff -kl ${srcdir}/Test0/*.* ${srcdir}/Test0/ORG; then echo "test OK"; if ! ${srcdir}/iCserver -h 2> /dev/null; then echo "- suggest you install Time::HiRes as described in the README followed by"; fi; echo "- make install as su"; else echo "test FAILED - differences in listed files and ${srcdir}/Test0/ORG"; fi

pedantic:
	@echo "compile with -P option and generate all executables from iC files in ${srcdir}/Test0 ..."
	@-${srcdir}/iCmake -PAiw. ${srcdir}/Test0/*.ic 2>&1 | $(PMOD) > ${srcdir}/Test0/Init.out
	@echo "show differences from generated files in ${srcdir}/Test0 with originals in ${srcdir}/Test0/PED ..."
	@if ${srcdir}/Mdiff -kLP -IC.OUTPUT -I__GNUC__ -I__extension__ -I#endif ${srcdir}/Test0/*.* ${srcdir}/Test0/PED; then echo "test OK"; if ! ${srcdir}/iCserver -h 2> /dev/null; then echo "- suggest you install Time::HiRes as described in the README followed by"; fi; echo "- make install as su"; else echo "test FAILED - differences in listed files and ${srcdir}/Test0/PED"; fi

install:	$(srcdir)/immcc.1.gz $(srcdir)/iCbox.1.gz $(srcdir)/iClift.1.gz $(srcdir)/iClive.1.gz $(srcdir)/iCmake.1.gz $(srcdir)/iCman.1.gz $(srcdir)/iCserver.1.gz $(srcdir)/makeAll.1.gz
	$(srcdir)/perlinstall -t $(srcdir)
	${INSTALL_PROGRAM} $(srcdir)/Msg.pm    `$(srcdir)/perlinstall`/Msg.pm
	${INSTALL_PROGRAM} immcc        ${bindir}/${binprefix}immcc
	${INSTALL_PROGRAM} icr          ${bindir}/${binprefix}icr
	${INSTALL_PROGRAM} ict          ${bindir}/${binprefix}ict
	${INSTALL_PROGRAM} $(srcdir)/iCbox      ${bindir}/${binprefix}iCbox
	${INSTALL_PROGRAM} $(srcdir)/iClift     ${bindir}/${binprefix}iClift
	${INSTALL_PROGRAM} $(srcdir)/iClive     ${bindir}/${binprefix}iClive
	${INSTALL_PROGRAM} $(srcdir)/iCmake     ${bindir}/${binprefix}iCmake
	${INSTALL_PROGRAM} $(srcdir)/iCman      ${bindir}/${binprefix}iCman
	${INSTALL_PROGRAM} $(srcdir)/iCserver   ${bindir}/${binprefix}iCserver
	${INSTALL_PROGRAM} $(srcdir)/pplstfix   ${bindir}/${binprefix}pplstfix
	${INSTALL_DATA} libict.a        ${prefix}/lib/libict.a
	@ranlib                         ${prefix}/lib/libict.a
	${INSTALL_DATA} $(srcdir)/icg.h         ${prefix}/include/icg.h
	${INSTALL_DATA} $(srcdir)/immcc.1.gz    ${prefix}/man/man1/immcc.1.gz
	${INSTALL_DATA} $(srcdir)/iCbox.1.gz    ${prefix}/man/man1/iCbox.1.gz
	${INSTALL_DATA} $(srcdir)/iClift.1.gz   ${prefix}/man/man1/iClift.1.gz
	${INSTALL_DATA} $(srcdir)/iClive.1.gz   ${prefix}/man/man1/iClive.1.gz
	${INSTALL_DATA} $(srcdir)/iCmake.1.gz   ${prefix}/man/man1/iCmake.1.gz
	${INSTALL_DATA} $(srcdir)/iCman.1.gz    ${prefix}/man/man1/iCman.1.gz
	${INSTALL_DATA} $(srcdir)/iCserver.1.gz ${prefix}/man/man1/iCserver.1.gz
	${INSTALL_DATA} $(srcdir)/makeAll.1.gz  ${prefix}/man/man1/makeAll.1.gz

uninstall:
	$(srcdir)/perlinstall -r $(srcdir)
	rm -f `$(srcdir)/perlinstall`/Msg.pm
	rm -f ${bindir}/${binprefix}immcc
	rm -f ${bindir}/${binprefix}icr
	rm -f ${bindir}/${binprefix}ict
	rm -f ${bindir}/${binprefix}iCbox
	rm -f ${bindir}/${binprefix}iClift
	rm -f ${bindir}/${binprefix}iClive
	rm -f ${bindir}/${binprefix}iCmake
	rm -f ${bindir}/${binprefix}iCman
	rm -f ${bindir}/${binprefix}iCserver
	rm -f ${bindir}/${binprefix}pplstfix
	rm -f ${prefix}/lib/libict.a
	rm -f ${prefix}/include/icg.h
	rm -f ${prefix}/man/man1/immcc.1.gz
	rm -f ${prefix}/man/man1/iCbox.1.gz
	rm -f ${prefix}/man/man1/iClift.1.gz
	rm -f ${prefix}/man/man1/iClive.1.gz
	rm -f ${prefix}/man/man1/iCmake.1.gz
	rm -f ${prefix}/man/man1/iCman.1.gz
	rm -f ${prefix}/man/man1/iCserver.1.gz
	rm -f ${prefix}/man/man1/makeAll.1.gz

clean:
	rm -rf *.$(O) $(srcdir)/comp.c $(srcdir)/gram.c $(srcdir)/lexc.c IcrObjs IctObjs LibObjs LmainObjs $(srcdir)/cexe.c $(srcdir)/scid.c $(srcdir)/icg.h core immcc icr ict libict.a lmain $(srcdir)/*.1.gz

distclean: clean
	rm -f $(srcdir)/Makefile $(srcdir)/config.status $(srcdir)/config.log $(srcdir)/config.cache $(srcdir)/../README

distribution:
	@rev=`$(PREV) $(srcdir)/scid.c`; echo "making icc_$$rev.tgz"; cd ${srcdir}/../..; tar -czf icc_$$rev.tgz `$(PADD) icc_$$rev/src/manifest`; cd -;

genr.$(O):	$(srcdir)/icc.h $(srcdir)/comp.h $(srcdir)/comp_tab.h
init.$(O):	$(srcdir)/icc.h $(srcdir)/comp.h $(srcdir)/comp_tab.h
symb.$(O):	$(srcdir)/icc.h $(srcdir)/comp.h $(srcdir)/comp_tab.h

comp.$(O):	$(srcdir)/comp.c $(srcdir)/icc.h $(srcdir)/comp.h
	$(CC) -I. $(CFLAGS_COMPILE_ONLY) $(CPPFLAGS) $(CFLAGS) $(O0) $<

icc.$(O):	$(srcdir)/icc.h $(srcdir)/comp.h $(srcdir)/cexe.h
outp.$(O):	$(srcdir)/icc.h $(srcdir)/comp.h
cexe.$(O):	$(srcdir)/cexe.c $(srcdir)/icc.h $(srcdir)/comp.h

ict.$(O):	$(srcdir)/icc.h $(srcdir)/tcpc.h
load.$(O):	$(srcdir)/icc.h $(srcdir)/tcpc.h

icr.$(O):	$(srcdir)/icc.h
link.$(O):	$(srcdir)/icc.h
rsff.$(O):	$(srcdir)/icc.h
scan.$(O):	$(srcdir)/icc.h

gram.$(O):	$(srcdir)/gram.c $(srcdir)/icc.h $(srcdir)/comp.h
	$(CC) -I. $(CFLAGS_COMPILE_ONLY) $(CPPFLAGS) $(CFLAGS) $(O0) $<

lexc.$(O):	$(srcdir)/lexc.c $(srcdir)/icc.h $(srcdir)/comp.h $(srcdir)/gram_tab.h
	$(CC) -I. $(CFLAGS_COMPILE_ONLY) $(CPPFLAGS) $(CFLAGS) $(O0) $<

lmain.$(O):	$(srcdir)/icc.h $(srcdir)/comp.h

misc.$(O):	$(srcdir)/icc.h

scid.$(O):	$(srcdir)/scid.c
